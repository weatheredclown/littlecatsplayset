<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Popsicle Party!</title>
    <style>
        /* --- CSS STYLES --- */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* Prevent scrolling */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #333;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* The Main Stage */
        #stage {
            flex-grow: 1;
            position: relative;
            background-size: cover;
            background-position: center bottom;
            overflow: hidden;
            touch-action: none;
            /* Important for touch dragging */
        }

        /* The Item Tray */
        #tray {
            height: 140px;
            background-image: url('images/green-background.png');
            /* Using your green bg */
            background-size: cover;
            background-color: #b2ebf2;
            /* Fallback color */
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 10px;
            box-shadow: 0px -4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        /* Tray Items (Thumbnails) */
        .tray-item {
            height: 100px;
            margin-right: 20px;
            cursor: grab;
            transition: transform 0.1s;
            filter: drop-shadow(2px 2px 0px rgba(255, 255, 255, 0.5));
        }

        .tray-item:hover {
            transform: scale(1.1);
        }

        .tray-item:active {
            cursor: grabbing;
        }

        /* Items placed on the stage */
        .sticker {
            position: absolute;
            cursor: grab;
            user-select: none;
            /* Default heights for stickers */
            height: 150px;
            filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.2));
            transition: transform 0.1s;
        }

        .sticker:active {
            cursor: grabbing;
            /* transform: scale(1.05);  Removed to avoid conflict with manual scaling */
        }

        .sticker.selected {
            outline: 3px dashed #fff;
            filter: drop-shadow(0px 0px 8px rgba(255, 255, 255, 0.8));
            z-index: 9999 !important;
            /* Always bring selected to very front */
        }

        /* Specific sizing tweaks for assets */
        .sticker[src*="images/p.png"] {
            height: 200px;
        }

        /* Cat needs to be big */
        .sticker[src*="images/v.png"] {
            height: 200px;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }

        #controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0px -4px 10px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
        }

        .control-pair {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #scale-container {
            display: none;
            align-items: center;
            gap: 10px;
            background: #ffeef7;
            border: 2px solid #333;
            border-radius: 16px;
            padding: 8px 14px;
            box-shadow: 3px 3px 0px #333;
        }

        #scale-container label {
            font-weight: 800;
            color: #333;
            letter-spacing: 0.5px;
        }

        #scale-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 160px;
            height: 14px;
            background: linear-gradient(90deg, #ffcf5c, #ff92c2);
            border: 2px solid #333;
            border-radius: 14px;
            box-shadow: 2px 2px 0px #333;
            cursor: pointer;
        }

        #scale-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #fffbe6;
            border: 2px solid #333;
            box-shadow: 2px 2px 0px #333;
        }

        #scale-slider::-moz-range-thumb {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #fffbe6;
            border: 2px solid #333;
            box-shadow: 2px 2px 0px #333;
        }

        #scale-slider::-moz-range-track {
            background: transparent;
        }

        .btn {
            background: linear-gradient(180deg, #fff7d1 0%, #ffd45a 100%);
            border: 2px solid #333;
            padding: 10px 18px;
            border-radius: 16px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 3px 3px 0px #333;
            color: #1f1405;
            letter-spacing: 0.4px;
            transition: transform 0.05s;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px #333;
        }

        .bg-selector {
            position: relative;
        }

        .bg-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 6px 10px;
            background: #fff;
            cursor: pointer;
            box-shadow: 2px 2px 0px #333;
            min-width: 170px;
        }

        .bg-toggle:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .bg-thumb {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .bg-label {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .bg-label span:first-child {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .bg-panel {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 10px;
            background: #fff;
            border: 2px solid #333;
            border-radius: 12px;
            box-shadow: 4px 4px 0px #333;
            z-index: 1500;
            min-width: 260px;
        }

        .bg-panel.open {
            display: grid;
        }

        .bg-option {
            border: 2px solid #333;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            padding-top: 60%;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .bg-option::after {
            content: attr(data-name);
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            color: #fff;
            padding: 4px 6px;
            font-size: 0.8rem;
            text-align: center;
        }

        /* Helper for drag text */
        .instruction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0, 0, 0, 0.3);
            font-size: 2rem;
            font-weight: bold;
            pointer-events: none;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="stage">
            <div class="instruction" id="tutorial-text">Drag items here!<br>Double click to remove.</div>
            <img src="images/banner.png" class="sticker" style="top: 20px; left: 20%;" id="main-banner">
        </div>

        <div id="controls">
            <div class="bg-selector" id="background-selector">
                <button class="bg-toggle" id="bg-toggle">
                    <div class="bg-thumb" id="bg-current"></div>
                    <div class="bg-label">
                        <span>Background</span>
                        <span id="bg-name">Loading...</span>
                    </div>
                </button>
                <div class="bg-panel" id="bg-panel"></div>
            </div>
            <div class="control-pair">
                <div id="scale-container">
                    <label for="scale-slider">Size</label>
                    <input type="range" id="scale-slider" min="0.5" max="3" step="0.1" value="1">
                </div>
                <button class="btn" onclick="clearStage()">Reset Scene</button>
            </div>
        </div>

        <div id="tray">

        </div>

        <script>
            // --- CONFIGURATION ---
            const stage = document.getElementById('stage');
            const tray = document.getElementById('tray');
            const scaleContainer = document.getElementById('scale-container');
            const scaleSlider = document.getElementById('scale-slider');
            const bgPanel = document.getElementById('bg-panel');
            const bgToggle = document.getElementById('bg-toggle');
            const bgCurrent = document.getElementById('bg-current');
            const bgName = document.getElementById('bg-name');
            const bgSelector = document.getElementById('background-selector');

            let highestZ = 10; // To keep track of layering
            let selectedSticker = null;
            let backgroundOptions = [];

            document.addEventListener('DOMContentLoaded', () => {
                initializeScene();
            });

            async function initializeScene() {
                try {
                    const [assetResponse, backgroundResponse] = await Promise.all([
                        fetch('assets.json'),
                        fetch('backgrounds.json')
                    ]);

                    const assetData = await assetResponse.json();
                    const bgData = await backgroundResponse.json();

                    const items = assetData.items || [];
                    backgroundOptions = bgData.backgrounds || [];

                    loadTray(items);
                    setupBackgroundWidget(backgroundOptions);
                    makeDraggable(document.getElementById('main-banner'));
                } catch (error) {
                    console.error('Error loading assets or backgrounds', error);
                }
            }

            // --- INITIALIZATION ---

            stage.addEventListener('mousedown', (e) => {
                if (e.target === stage) deselectSticker();
            });

            stage.addEventListener('touchstart', (e) => {
                if (e.target === stage) deselectSticker();
            });

            scaleSlider.addEventListener('input', (e) => {
                if (selectedSticker) {
                    const scale = e.target.value;
                    selectedSticker.style.transform = `scale(${scale})`;
                    selectedSticker.dataset.scale = scale;
                }
            });

            document.addEventListener('click', (e) => {
                if (!bgSelector.contains(e.target)) {
                    bgPanel.classList.remove('open');
                }
            });

            // --- LOGIC ---

            function loadTray(items) {
                tray.innerHTML = '';
                items.forEach(({ src, name }) => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = name || '';
                    img.className = 'tray-item';
                    img.title = name || '';
                    img.onmousedown = (e) => spawnSticker(e, src);
                    img.ontouchstart = (e) => spawnSticker(e, src);
                    tray.appendChild(img);
                });
            }

            function setupBackgroundWidget(backgrounds) {
                bgPanel.innerHTML = '';
                if (!backgrounds.length) {
                    bgToggle.disabled = true;
                    bgName.textContent = 'No backgrounds';
                    return;
                }

                bgToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    bgPanel.classList.toggle('open');
                });

                backgrounds.forEach((bg) => {
                    const option = document.createElement('button');
                    option.className = 'bg-option';
                    option.style.backgroundImage = `url('${bg.src}')`;
                    option.dataset.name = bg.name || '';
                    option.onclick = (e) => {
                        e.stopPropagation();
                        applyBackground(bg);
                        bgPanel.classList.remove('open');
                    };
                    bgPanel.appendChild(option);
                });

                applyBackground(backgrounds[0]);
            }

            function applyBackground(bg) {
                stage.style.backgroundImage = `url('${bg.src}')`;
                bgCurrent.style.backgroundImage = `url('${bg.src}')`;
                bgName.textContent = bg.name || 'Background';
            }

            function spawnSticker(e, filename) {
                e.preventDefault(); // Stop default browser dragging

                // Hide tutorial text
                document.getElementById('tutorial-text').style.display = 'none';

                const sticker = document.createElement('img');
                sticker.src = filename;
                sticker.className = 'sticker';

                // Center the new sticker on the mouse/finger initially
                // We need to append it to stage to get its size, then position it
                stage.appendChild(sticker);

                const stageRect = stage.getBoundingClientRect();

                // Determine input coordinates (Mouse vs Touch)
                let clientX = e.clientX;
                let clientY = e.clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }

                // Position it roughly where the user clicked in the tray,
                // but adjusted for the stage coordinates
                sticker.style.left = (clientX - stageRect.left - (sticker.offsetWidth / 2)) + 'px';
                sticker.style.top = (clientY - stageRect.top - (sticker.offsetHeight / 2)) + 'px';

                // Apply z-index
                highestZ++;
                sticker.style.zIndex = highestZ;

                // Make it draggable immediately
                makeDraggable(sticker);

                // Select it immediately
                selectSticker(sticker);

                // Trigger the drag start immediately so it feels like pulling it off the shelf
                startDrag(e, sticker);
            }

            function makeDraggable(el) {
                // bring to front on click and select
                const onInteract = (e) => {
                    el.style.zIndex = ++highestZ;
                    selectSticker(el);
                };

                el.addEventListener('mousedown', onInteract);
                el.addEventListener('touchstart', onInteract);

                // Double click to remove
                el.addEventListener('dblclick', () => {
                    createPoof(el);
                    el.remove();
                    if (selectedSticker === el) {
                        deselectSticker();
                    }
                });

                el.onmousedown = (e) => startDrag(e, el);
                el.ontouchstart = (e) => startDrag(e, el);
            }

            function startDrag(e, el) {
                e.preventDefault();

                let startX, startY, initialLeft, initialTop;

                if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else {
                    startX = e.clientX;
                    startY = e.clientY;
                }

                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;

                function moveAt(e) {
                    let currentX, currentY;

                    if (e.type === 'touchmove') {
                        currentX = e.touches[0].clientX;
                        currentY = e.touches[0].clientY;
                    } else {
                        currentX = e.clientX;
                        currentY = e.clientY;
                    }

                    const deltaX = currentX - startX;
                    const deltaY = currentY - startY;

                    el.style.left = (initialLeft + deltaX) + 'px';
                    el.style.top = (initialTop + deltaY) + 'px';
                }

                function stopDrag() {
                    document.removeEventListener('mousemove', moveAt);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchmove', moveAt);
                    document.removeEventListener('touchend', stopDrag);
                }

                document.addEventListener('mousemove', moveAt);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', moveAt, { passive: false });
                document.addEventListener('touchend', stopDrag);
            }

            function createPoof(el) {
                // Optional: Add a little animation effect when deleting (not implemented to keep simple)
                // You could add a sound effect here too!
            }

            function clearStage() {
                const stickers = document.querySelectorAll('.sticker');
                stickers.forEach(s => s.remove());
                deselectSticker();

                // Add back the banner just for fun, or leave empty
                const newBanner = document.createElement('img');
                newBanner.src = 'images/banner.png';
                newBanner.className = 'sticker';
                newBanner.style.top = '20px';
                newBanner.style.left = '20%';
                newBanner.id = 'main-banner';
                stage.appendChild(newBanner);
                makeDraggable(newBanner);
            }

            function selectSticker(el) {
                if (selectedSticker) {
                    selectedSticker.classList.remove('selected');
                }
                selectedSticker = el;
                selectedSticker.classList.add('selected');

                // Get current scale or default to 1
                const currentScale = selectedSticker.dataset.scale || 1;
                scaleSlider.value = currentScale;

                scaleContainer.style.display = 'flex';
            }

            function deselectSticker() {
                if (selectedSticker) {
                    selectedSticker.classList.remove('selected');
                    selectedSticker = null;
                }
                scaleContainer.style.display = 'none';
            }

        </script>
</body>

</html>